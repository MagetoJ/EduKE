# Render Deployment Guide for EduKE

## Overview

This guide provides step-by-step instructions for deploying EduKE to Render, a modern cloud platform. The deployment includes:

- **Frontend**: React/Vite static site
- **Backend**: Node.js/Express API server
- **Database**: PostgreSQL database
- **Environment Detection**: Automatic production/development environment handling

---

## Prerequisites

Before deploying to Render, ensure you have:

1. **Render Account**: Sign up at [https://render.com](https://render.com)
2. **GitHub Repository**: Push your code to GitHub (Render integrates with GitHub)
3. **Git Configured**: Ensure your project is under version control
4. **Environment Variables Ready**: Have your secrets prepared

---

## Step 1: Connect Your GitHub Repository to Render

1. Log in to your **Render Dashboard**
2. Click **New +** button and select **New Web Service**
3. Click **Connect a GitHub repository**
4. Authorize Render to access your GitHub account
5. Select your repository
6. Click **Connect**

---

## Step 2: Deploy with render.yaml Blueprint (Monorepo)

The `render.yaml` file in your project root contains the complete deployment configuration for a **monorepo** with a single web service.

### Deploy Using render.yaml:

1. In Render Dashboard, click **New +** ‚Üí **Blueprint**
2. Paste your GitHub repository URL
3. Render will automatically detect and use your `render.yaml` file
4. Review the services:
   - `eduke` (Monorepo - Backend + Frontend)
   - `eduke-database` (PostgreSQL)
5. Click **Create New Services**

### What render.yaml Configures (Monorepo):

```yaml
services:
  - Monorepo Web Service (Node.js/Express)
    - Builds frontend: npm run build (creates dist/)
    - Builds backend: cd server && npm install
    - Single Express server serves both
    - Frontend static files cached
    - API routes at /api/*
    - Health check enabled
    - Persistent storage for uploads
    
  - PostgreSQL Database
    - Version 15
    - 50GB storage
    - Automatic connection string
```

### Advantages of Monorepo Deployment:

‚úÖ **Simpler**: One service instead of two  
‚úÖ **Cheaper**: One web service tier instead of two  
‚úÖ **Unified**: Shared environment variables  
‚úÖ **Faster**: No inter-service communication delay  
‚úÖ **Easier**: Single deployment and logs

---

## Step 3: Configure Environment Variables

### For Monorepo Service (eduke)

Since this is a monorepo with a single service, all environment variables go in one place.

1. Go to **eduke** service dashboard
2. Click **Environment** tab
3. Add the following environment variables:

#### Required Variables (Pre-configured in render.yaml):

```
NODE_ENV = production
APP_ENV = production
USE_PRODUCTION_DB = true
PORT = 3000
```

#### Security Secrets (Generate new values - MUST ADD):

Run in your terminal to generate:
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

Then add to Environment tab:

```
JWT_SECRET = [Generate strong random string]
JWT_REFRESH_SECRET = [Generate strong random string]
```

#### Frontend & CORS Variables (Pre-configured):

```
CORS_ORIGIN = https://eduke.onrender.com
FRONTEND_URL = https://eduke.onrender.com
VITE_API_URL = https://eduke.onrender.com/api
```

#### Database Variables (Auto-populated):

```
DATABASE_URL = [Auto-set from eduke-database service]
```

#### Optional Variables:

```
RATE_LIMIT_WINDOW_MS = 900000
RATE_LIMIT_MAX_REQUESTS = 100
SMTP_HOST = smtp.gmail.com
SMTP_PORT = 587
```

### For Database Service (eduke-database)

The database variables are pre-configured in render.yaml:

```
POSTGRES_DB = eduke
POSTGRES_USER = eduke_user
POSTGRES_PASSWORD = [Generated by Render]
```

---

## Step 4: Initialize Database Schema

After services are deployed:

1. Go to **eduke-server** service
2. Click **Shell** to open terminal
3. Run database initialization:

```bash
# Initialize database with schema
NODE_ENV=production node scripts/init-db.js --production

# Or if using a different initialization script
NODE_ENV=production npm run db:init:prod
```

---

## Step 5: Verify Environment Detection

The application automatically detects production/development environments:

### Production Environment Indicators:

When deployed to Render, your application will:

1. **Automatically detect production mode** from:
   - `NODE_ENV=production` environment variable
   - `APP_ENV=production` environment variable

2. **Adjust behavior accordingly**:
   - Use PostgreSQL database (not SQLite)
   - Enable production CORS restrictions
   - Use production API endpoints
   - Enable security headers

3. **Show production startup logs**:
   ```
   ======================================================================
   üöÄ EduKE Server Started
   ======================================================================
   üìç Server listening on port: 3001
   üåç NODE_ENV: production
   üåç APP_ENV: production
   ‚öôÔ∏è  Environment Mode: PRODUCTION üîí
   üîó CORS Origin: https://eduke-client.onrender.com
   üíæ Database: PostgreSQL (production)
   ======================================================================
   ‚úÖ Ready to accept requests!
   ```

### Development Environment Indicators:

Locally, without `NODE_ENV=production`:

```
‚öôÔ∏è  Environment Mode: DEVELOPMENT
üîó CORS Origin: http://localhost:5173
üíæ Database: SQLite (development)
```

---

## Step 6: Verify Deployment

### Check Monorepo Service Health:

```bash
curl https://eduke.onrender.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "database": {
    "config": "PostgreSQL (production)",
    "tableCount": 15,
    "database": "eduke"
  },
  "timestamp": "2024-11-20T10:30:00.000Z"
}
```

### Check Frontend Application:

Open `https://eduke.onrender.com` in your browser  
(Frontend is served from the same monorepo service)

### Monitor Logs:

1. Go to **eduke** service dashboard
2. Click **Logs** to view real-time logs
3. Check for errors or warnings

### Test API Endpoint:

```bash
# This should require authentication but shouldn't error
curl https://eduke.onrender.com/api/health
```

---

## Environment Detection Code

The application uses environment variables to detect and configure for the right environment:

### server/config.js:
```javascript
const NODE_ENV = process.env.NODE_ENV || 'development';
const APP_ENV = process.env.APP_ENV || NODE_ENV;
const isProduction = NODE_ENV === 'production' || APP_ENV === 'production';
```

### server/index.js:
```javascript
const { isProduction, NODE_ENV, APP_ENV } = require('./config');

const corsOptions = {
  origin: isProduction ? process.env.CORS_ORIGIN : 'http://localhost:5173',
  credentials: true
};
```

### server/database.js:
```javascript
const useProduction = process.env.USE_PRODUCTION_DB !== 'false';

if (useProduction) {
  // Use PostgreSQL with SSL
  db = new Pool(getDbConfig());
} else {
  // Use SQLite for local development
  db = new sqlite3.Database(dbPath);
}
```

---

## Common Issues and Solutions

### Issue 1: Database Connection Error

**Symptom**: `ECONNREFUSED` or `ENOTFOUND`

**Solution**:
1. Verify `DATABASE_URL` is set correctly in Render dashboard
2. Ensure PostgreSQL database service is running
3. Check database credentials in Environment tab
4. Verify `sslmode=require` is in connection string

### Issue 2: CORS Error in Frontend

**Symptom**: `Access to XMLHttpRequest blocked by CORS`

**Solution**:
1. Verify `CORS_ORIGIN` matches your frontend URL
2. Update in backend environment: `CORS_ORIGIN=https://eduke-client.onrender.com`
3. Ensure frontend uses correct API URL
4. Clear browser cache and refresh

### Issue 3: Authentication Fails

**Symptom**: Login fails, JWT errors in console

**Solution**:
1. Regenerate `JWT_SECRET` and `JWT_REFRESH_SECRET` in Render dashboard
2. Ensure JWT variables match between frontend and backend
3. Check token expiration times are reasonable
4. Verify database has user records

### Issue 4: Build Failures

**Symptom**: Deploy fails during build step

**Solution**:
1. Check build logs in Render dashboard
2. Ensure all dependencies are in package.json
3. Run `npm install` locally to verify dependencies
4. Check for TypeScript/ESLint errors
5. Verify buildCommand in render.yaml is correct

### Issue 5: Uploads Not Persisting

**Symptom**: Uploaded files disappear after restart

**Solution**:
1. Verify persistent disk is mounted in render.yaml:
   ```yaml
   disk:
     name: eduke-uploads
     mountPath: /opt/render/project/server/uploads
     sizeGB: 10
   ```
2. Ensure upload directory path matches mountPath
3. Restart service to test persistence

---

## Security Best Practices

1. **Never commit secrets** to git:
   - Generate new JWT secrets for production
   - Use Render dashboard to manage secrets
   - Rotate secrets periodically

2. **Database Security**:
   - Change default PostgreSQL password
   - Restrict IP access in firewall rules
   - Enable SSL for connections

3. **Frontend Security**:
   - Use HTTPS only (Render provides free SSL)
   - Set secure CORS origins
   - Implement CSP headers

4. **Backend Security**:
   - Enable rate limiting
   - Validate all inputs
   - Use bcrypt for passwords
   - Implement proper authentication

---

## Monitoring and Maintenance

### View Logs:

```bash
# Real-time logs in Render dashboard
# Services ‚Üí [service-name] ‚Üí Logs
```

### Monitor Performance:

1. Render Dashboard ‚Üí Metrics tab
2. Check CPU, memory, and bandwidth usage
3. Monitor database query performance

### Scheduled Maintenance:

- **Database**: Set maintenance window in PostgreSQL service settings
- **Backups**: Enable automatic backups (available on Pro plan)
- **Updates**: Monitor for platform updates

---

## Scaling Your Deployment

### Scale Backend:

1. Go to **eduke-server** ‚Üí Settings
2. Increase **Num Instances** for horizontal scaling
3. Use load balancer (automatic with multiple instances)

### Scale Database:

1. Go to **eduke-database** ‚Üí Settings
2. Increase disk size as needed
3. Upgrade to higher plan if needed

---

## Deployment Workflow

### Automatic Deployments:

1. Push code to GitHub
2. Render automatically detects changes
3. Triggers build and deploy (visible in dashboard)
4. New version deployed to production

### Manual Deployments:

1. Go to service dashboard
2. Click **Redeploy** to trigger manual redeploy
3. Select commit/branch to deploy

---

## Troubleshooting Environment Detection

### Verify Environment Variables:

**In Render Dashboard**:
1. Service ‚Üí Environment tab
2. Check all variables are set correctly

**In Application Logs**:
- Look for startup messages showing environment
- Search for "Environment Mode:" in logs

**Health Check Endpoint**:
```bash
curl https://eduke-server.onrender.com/health
```

---

## Rolling Back to Previous Version

1. Go to service dashboard
2. Click **Deployments** tab
3. Select previous deployment
4. Click **Redeploy this**
5. Confirm rollback

---

## Additional Resources

- **Render Documentation**: [https://render.com/docs](https://render.com/docs)
- **Node.js Best Practices**: [https://nodejs.org/en/docs/guides/nodejs-docker-webapp/](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)
- **PostgreSQL Deployment**: [https://www.postgresql.org/](https://www.postgresql.org/)
- **React/Vite Guide**: [https://vitejs.dev/guide/](https://vitejs.dev/guide/)

---

## Support and Troubleshooting

For issues:

1. Check Render Dashboard logs
2. Review this guide's troubleshooting section
3. Contact Render support: [https://render.com/support](https://render.com/support)
4. Check application health endpoint
5. Review environment variables configuration

---

**Last Updated**: November 2024  
**Version**: 1.0
